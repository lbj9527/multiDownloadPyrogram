# ğŸ“¦ åª’ä½“ç»„æ„ŸçŸ¥çš„ä»»åŠ¡åˆ†é…åŠŸèƒ½

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

åª’ä½“ç»„æ„ŸçŸ¥çš„ä»»åŠ¡åˆ†é…æ˜¯å¯¹åŸæœ‰ä¸‹è½½å™¨çš„é‡å¤§æ”¹è¿›ï¼Œè§£å†³äº†åª’ä½“ç»„è¢«æ‹†åˆ†çš„é—®é¢˜ï¼ŒåŒæ—¶ä¿æŒäº†å¤šå®¢æˆ·ç«¯å¹¶å‘ä¸‹è½½çš„é«˜æ•ˆæ€§ã€‚

## ğŸ”§ æ ¸å¿ƒç‰¹æ€§

### âœ… è§£å†³çš„é—®é¢˜
- **åª’ä½“ç»„å®Œæ•´æ€§**: ç¡®ä¿åŒä¸€åª’ä½“ç»„çš„æ‰€æœ‰æ–‡ä»¶åˆ†é…ç»™åŒä¸€å®¢æˆ·ç«¯
- **è´Ÿè½½å‡è¡¡**: æ™ºèƒ½åˆ†é…ä»»åŠ¡ï¼Œä¿æŒå®¢æˆ·ç«¯é—´çš„è´Ÿè½½å¹³è¡¡
- **é›¶é¢å¤–æˆæœ¬**: ä¸å¢åŠ APIè°ƒç”¨æ¬¡æ•°ï¼Œä¸éœ€è¦ç­‰å¾…æ—¶é—´
- **é«˜åº¦å¯é…ç½®**: æ”¯æŒå¤šç§åˆ†é…ç­–ç•¥å’Œè´Ÿè½½å‡è¡¡æŒ‡æ ‡

### ğŸ—ï¸ æ¶æ„è®¾è®¡
- **æ¨¡å—åŒ–**: æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤
- **ç­–ç•¥æ¨¡å¼**: æ”¯æŒå¤šç§åˆ†é…ç­–ç•¥ï¼Œå¯åŠ¨æ€åˆ‡æ¢
- **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°çš„åˆ†é…ç­–ç•¥å’Œè´Ÿè½½å‡è¡¡ç®—æ³•

## ğŸ“‹ åˆ†é…ç­–ç•¥

### 1. èŒƒå›´åˆ†é… (range_based)
- **æè¿°**: æŒ‰æ¶ˆæ¯IDèŒƒå›´å¹³å‡åˆ†é…ï¼ˆåŸæœ‰æ–¹å¼ï¼‰
- **ä¼˜ç‚¹**: å®ç°ç®€å•ï¼Œé€Ÿåº¦å¿«
- **ç¼ºç‚¹**: å¯èƒ½æ‹†åˆ†åª’ä½“ç»„
- **é€‚ç”¨åœºæ™¯**: æ²¡æœ‰åª’ä½“ç»„æˆ–ä¸å…³å¿ƒåª’ä½“ç»„å®Œæ•´æ€§

### 2. åª’ä½“ç»„æ„ŸçŸ¥åˆ†é… (media_group_aware) â­æ¨è
- **æè¿°**: ä¿æŒåª’ä½“ç»„å®Œæ•´æ€§çš„æ™ºèƒ½åˆ†é…
- **ä¼˜ç‚¹**: å®Œç¾ä¿æŒåª’ä½“ç»„ï¼Œè´Ÿè½½ç›¸å¯¹å‡è¡¡
- **ç¼ºç‚¹**: ç•¥å¾®å¤æ‚
- **é€‚ç”¨åœºæ™¯**: å¤§å¤šæ•°æƒ…å†µä¸‹çš„æœ€ä½³é€‰æ‹©

### 3. è´Ÿè½½å‡è¡¡åˆ†é… (load_balanced)
- **æè¿°**: é«˜çº§è´Ÿè½½å‡è¡¡ï¼Œæ”¯æŒå¤šç§å‡è¡¡æŒ‡æ ‡
- **ä¼˜ç‚¹**: æœ€ä½³çš„è´Ÿè½½å‡è¡¡æ•ˆæœ
- **ç¼ºç‚¹**: è®¡ç®—å¤æ‚åº¦è¾ƒé«˜
- **é€‚ç”¨åœºæ™¯**: å¯¹è´Ÿè½½å‡è¡¡è¦æ±‚æé«˜çš„åœºæ™¯

### 4. è‡ªåŠ¨é€‰æ‹© (auto)
- **æè¿°**: æ ¹æ®æ•°æ®ç‰¹å¾è‡ªåŠ¨é€‰æ‹©æœ€é€‚åˆçš„ç­–ç•¥
- **ä¼˜ç‚¹**: æ— éœ€æ‰‹åŠ¨é…ç½®
- **ç¼ºç‚¹**: å¯èƒ½ä¸ç¬¦åˆç‰¹å®šéœ€æ±‚
- **é€‚ç”¨åœºæ™¯**: ä¸ç¡®å®šä½¿ç”¨å“ªç§ç­–ç•¥æ—¶

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# åŸºç¡€åˆ†é…é…ç½®
TASK_DISTRIBUTION_MODE=media_group_aware
LOAD_BALANCE_METRIC=file_count
MAX_IMBALANCE_RATIO=0.3
PREFER_LARGE_GROUPS_FIRST=true
ENABLE_DISTRIBUTION_VALIDATION=true

# æ€§èƒ½é…ç½®
GROUPING_BATCH_SIZE=200
GROUPING_MAX_RETRIES=3
GROUPING_TIMEOUT=30.0

# è°ƒè¯•é…ç½®
ENABLE_STRATEGY_COMPARISON=false
AUTO_STRATEGY_RECOMMENDATION=true
```

### é…ç½®å‚æ•°è¯¦è§£

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `TASK_DISTRIBUTION_MODE` | `media_group_aware` | ä»»åŠ¡åˆ†é…æ¨¡å¼ |
| `LOAD_BALANCE_METRIC` | `file_count` | è´Ÿè½½å‡è¡¡æŒ‡æ ‡ |
| `MAX_IMBALANCE_RATIO` | `0.3` | æœ€å¤§ä¸å‡è¡¡æ¯”ä¾‹ |
| `PREFER_LARGE_GROUPS_FIRST` | `true` | ä¼˜å…ˆåˆ†é…å¤§åª’ä½“ç»„ |
| `ENABLE_DISTRIBUTION_VALIDATION` | `true` | å¯ç”¨åˆ†é…ç»“æœéªŒè¯ |

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€ä½¿ç”¨
```bash
# ä½¿ç”¨é»˜è®¤çš„åª’ä½“ç»„æ„ŸçŸ¥åˆ†é…
python main.py
```

### 2. æŒ‡å®šåˆ†é…ç­–ç•¥
```bash
# ä½¿ç”¨è´Ÿè½½å‡è¡¡åˆ†é…
TASK_DISTRIBUTION_MODE=load_balanced python main.py

# ä½¿ç”¨ä¼ ç»ŸèŒƒå›´åˆ†é…
TASK_DISTRIBUTION_MODE=range_based python main.py
```

### 3. æµ‹è¯•åŠŸèƒ½
```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
python test_media_group_distribution.py
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### åˆ†é…æ•ˆæœç¤ºä¾‹

**ä¼ ç»ŸèŒƒå›´åˆ†é…:**
```
å®¢æˆ·ç«¯1: æ¶ˆæ¯ 72006-72055 (å¯èƒ½åŒ…å«ä¸å®Œæ•´çš„åª’ä½“ç»„)
å®¢æˆ·ç«¯2: æ¶ˆæ¯ 72056-72105 (å¯èƒ½åŒ…å«ä¸å®Œæ•´çš„åª’ä½“ç»„)  
å®¢æˆ·ç«¯3: æ¶ˆæ¯ 72106-72155 (å¯èƒ½åŒ…å«ä¸å®Œæ•´çš„åª’ä½“ç»„)
```

**åª’ä½“ç»„æ„ŸçŸ¥åˆ†é…:**
```
å®¢æˆ·ç«¯1: åª’ä½“ç»„A(5æ–‡ä»¶) + åª’ä½“ç»„B(3æ–‡ä»¶) + å•æ¶ˆæ¯10ä¸ª = 18æ–‡ä»¶
å®¢æˆ·ç«¯2: åª’ä½“ç»„C(7æ–‡ä»¶) + åª’ä½“ç»„D(2æ–‡ä»¶) + å•æ¶ˆæ¯8ä¸ª = 17æ–‡ä»¶
å®¢æˆ·ç«¯3: åª’ä½“ç»„E(4æ–‡ä»¶) + åª’ä½“ç»„F(6æ–‡ä»¶) + å•æ¶ˆæ¯5ä¸ª = 15æ–‡ä»¶
```

### è´Ÿè½½å‡è¡¡æŒ‡æ ‡

| æŒ‡æ ‡ | ä¼ ç»Ÿåˆ†é… | åª’ä½“ç»„æ„ŸçŸ¥åˆ†é… |
|------|----------|----------------|
| **åª’ä½“ç»„å®Œæ•´æ€§** | âŒ å¯èƒ½ç ´å | âœ… å®Œå…¨ä¿æŒ |
| **è´Ÿè½½å‡è¡¡æ¯”ä¾‹** | ~1.0 | ~0.85-0.95 |
| **APIè°ƒç”¨æ¬¡æ•°** | æ ‡å‡† | æ ‡å‡† |
| **å†…å­˜å ç”¨** | ä½ | ä½ |
| **å¤„ç†æ—¶é—´** | å¿« | ç•¥æ…¢ |

## ğŸ” å·¥ä½œæµç¨‹

### 1. æ¶ˆæ¯åˆ†ç»„é˜¶æ®µ
```mermaid
graph TD
    A[è·å–æ¶ˆæ¯èŒƒå›´] --> B[æ‰¹é‡è·å–æ¶ˆæ¯]
    B --> C[æŒ‰media_group_idåˆ†ç»„]
    C --> D[éªŒè¯åˆ†ç»„ç»“æœ]
```

### 2. ä»»åŠ¡åˆ†é…é˜¶æ®µ
```mermaid
graph TD
    A[è·å–æ‰€æœ‰æ¶ˆæ¯ç»„] --> B[æŒ‰å¤§å°æ’åº]
    B --> C[è´ªå¿ƒç®—æ³•åˆ†é…]
    C --> D[è´Ÿè½½å‡è¡¡éªŒè¯]
```

### 3. å¹¶å‘ä¸‹è½½é˜¶æ®µ
```mermaid
graph TD
    A[å®¢æˆ·ç«¯1ä»»åŠ¡] --> D[å¹¶å‘ä¸‹è½½]
    B[å®¢æˆ·ç«¯2ä»»åŠ¡] --> D
    C[å®¢æˆ·ç«¯3ä»»åŠ¡] --> D
    D --> E[ç»“æœæ±‡æ€»]
```

## ğŸ› ï¸ æ‰©å±•å¼€å‘

### æ·»åŠ è‡ªå®šä¹‰åˆ†é…ç­–ç•¥

```python
from core.task_distribution.base import TaskDistributionStrategy

class CustomDistributionStrategy(TaskDistributionStrategy):
    async def distribute_tasks(self, message_collection, client_names):
        # å®ç°è‡ªå®šä¹‰åˆ†é…é€»è¾‘
        pass
    
    def get_strategy_info(self):
        return {
            "name": "CustomDistribution",
            "description": "è‡ªå®šä¹‰åˆ†é…ç­–ç•¥"
        }

# æ³¨å†Œç­–ç•¥
distributor.register_strategy(DistributionMode.CUSTOM, CustomDistributionStrategy)
```

### æ·»åŠ è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡æŒ‡æ ‡

```python
def custom_load_calculator(assignment):
    # å®ç°è‡ªå®šä¹‰è´Ÿè½½è®¡ç®—é€»è¾‘
    return assignment.total_files * 0.7 + assignment.estimated_size / (1024*1024) * 0.3
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **åˆ†é…ä¸å‡è¡¡**
   - æ£€æŸ¥ `MAX_IMBALANCE_RATIO` è®¾ç½®
   - å°è¯•ä¸åŒçš„ `LOAD_BALANCE_METRIC`

2. **åª’ä½“ç»„ä»è¢«æ‹†åˆ†**
   - ç¡®è®¤ä½¿ç”¨ `media_group_aware` æˆ– `load_balanced` æ¨¡å¼
   - æ£€æŸ¥æ—¥å¿—ä¸­çš„åˆ†é…è¯¦æƒ…

3. **æ€§èƒ½é—®é¢˜**
   - è°ƒæ•´ `GROUPING_BATCH_SIZE`
   - æ£€æŸ¥ `GROUPING_TIMEOUT` è®¾ç½®

### è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨ç­–ç•¥æ¯”è¾ƒæ¨¡å¼
ENABLE_STRATEGY_COMPARISON=true python main.py

# å¯ç”¨è¯¦ç»†æ—¥å¿—
LOG_LEVEL=DEBUG python main.py
```

## ğŸ“ˆ æœªæ¥æ‰©å±•

### è®¡åˆ’ä¸­çš„åŠŸèƒ½
- [ ] åŸºäºæ–‡ä»¶å¤§å°çš„ç²¾ç¡®è´Ÿè½½å‡è¡¡
- [ ] æ”¯æŒå®¢æˆ·ç«¯æ€§èƒ½å·®å¼‚çš„æ™ºèƒ½åˆ†é…
- [ ] åˆ†é…ç­–ç•¥çš„æœºå™¨å­¦ä¹ ä¼˜åŒ–
- [ ] å®æ—¶è´Ÿè½½ç›‘æ§å’ŒåŠ¨æ€è°ƒæ•´
- [ ] åˆ†å¸ƒå¼å¤šæœºå™¨æ”¯æŒ

### è´¡çŒ®æŒ‡å—
æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªåŠŸèƒ½ï¼

## ğŸ“„ è®¸å¯è¯
ä¸ä¸»é¡¹ç›®ä¿æŒä¸€è‡´
