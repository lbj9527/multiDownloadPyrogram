# ğŸ“‹ ä¼˜åŒ–çš„ä¸Šä¼ åª’ä½“ç»„æ”¶é›†é€»è¾‘è®¾è®¡

## ğŸ¯ æ¦‚è¿°

é‡æ–°è®¾è®¡çš„ä¸Šä¼ é€»è¾‘è§£å†³äº†åŸæœ‰é€»è¾‘çš„å…³é”®é—®é¢˜ï¼šåª’ä½“ç»„æ¶ˆæ¯æ•°é‡å¯èƒ½å°äº10ä¸ªã€‚æ–°é€»è¾‘åŸºäºåª’ä½“ç»„IDå˜åŒ–æ£€æµ‹æ¥åˆ¤æ–­åª’ä½“ç»„å®Œæ•´æ€§ï¼Œå¹¶ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯ç»´æŠ¤ç‹¬ç«‹çš„ä¸Šä¼ é˜Ÿåˆ—ï¼Œç¡®ä¿ä¸Šä¼ é¡ºåºå’Œå®Œæ•´æ€§ã€‚

## ğŸš¨ åŸæœ‰é€»è¾‘çš„é—®é¢˜

1. **å›ºå®šæ•°é‡å‡è®¾**: åŸé€»è¾‘å‡è®¾åª’ä½“ç»„æ€»æ˜¯åŒ…å«10ä¸ªæ–‡ä»¶ï¼Œä½†å®é™…ä¸Šåª’ä½“ç»„å¯èƒ½åŒ…å«2-10ä¸ªä»»æ„æ•°é‡çš„æ–‡ä»¶
2. **å®Œæ•´æ€§åˆ¤æ–­é”™è¯¯**: åŸºäºæ–‡ä»¶æ•°é‡è€Œéåª’ä½“ç»„IDå˜åŒ–æ¥åˆ¤æ–­å®Œæ•´æ€§
3. **å¹¶å‘æ··ä¹±**: ç¼ºä¹å®¢æˆ·ç«¯çº§åˆ«çš„ä¸Šä¼ é˜Ÿåˆ—ï¼Œå¯èƒ½å¯¼è‡´ä¸Šä¼ é¡ºåºæ··ä¹±

## ğŸ” æ ¸å¿ƒç»„ä»¶

### 1. å®¢æˆ·ç«¯ä¸Šä¼ çŠ¶æ€ç®¡ç†

```python
@dataclass
class ClientUploadState:
    """å®¢æˆ·ç«¯ä¸Šä¼ çŠ¶æ€"""
    client_name: str
    current_media_group_id: Optional[str] = None
    media_group_cache: List[Dict] = field(default_factory=list)
    upload_queue: asyncio.Queue = field(default_factory=asyncio.Queue)
    is_uploading: bool = False
    upload_lock: asyncio.Lock = field(default_factory=asyncio.Lock)

class UploadService:
    def __init__(self):
        # æ¯ä¸ªå®¢æˆ·ç«¯çš„ä¸Šä¼ çŠ¶æ€
        self.client_upload_states: Dict[str, ClientUploadState] = {}
        # ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯å¯åŠ¨ä¸Šä¼ å¤„ç†åç¨‹
        self.upload_tasks: Dict[str, asyncio.Task] = {}
```

### 2. åª’ä½“ç»„è¯†åˆ«

```python
def _is_media_group_message(self, message: Any) -> bool:
    """æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å±äºåª’ä½“ç»„"""
    return hasattr(message, 'media_group_id') and message.media_group_id is not None

def _get_client_name(self, client: Client) -> str:
    """è·å–å®¢æˆ·ç«¯åç§°"""
    return getattr(client, 'name', f'client_{id(client)}')
```

## ğŸ”„ ä¼˜åŒ–çš„å¤„ç†æµç¨‹

### ä¸»æµç¨‹å›¾

```
æ¶ˆæ¯è¾“å…¥
    â†“
è·å–å®¢æˆ·ç«¯çŠ¶æ€
    â†“
æ˜¯å¦ä¸ºåª’ä½“ç»„æ¶ˆæ¯ï¼Ÿ
    â†“ æ˜¯                           â†“ å¦
åª’ä½“ç»„IDæ˜¯å¦ä¸å½“å‰ç¼“å­˜ç›¸åŒï¼Ÿ      ä¸Šä¼ å½“å‰ç¼“å­˜çš„åª’ä½“ç»„
    â†“ æ˜¯            â†“ å¦              â†“
æ·»åŠ åˆ°ç¼“å­˜      ä¸Šä¼ å½“å‰ç¼“å­˜      ç«‹å³ä¸Šä¼ å•æ¡æ¶ˆæ¯
    â†“           å¼€å§‹æ–°åª’ä½“ç»„           â†“
ç­‰å¾…ä¸‹ä¸€æ¡æ¶ˆæ¯      â†“               å®Œæˆ
                æ·»åŠ åˆ°ç¼“å­˜
                    â†“
                ç­‰å¾…ä¸‹ä¸€æ¡æ¶ˆæ¯
```

### 1. æ¶ˆæ¯å¤„ç†å…¥å£

```python
async def upload_message(
    self,
    client: Client,
    original_message: Any,
    media_data: Optional[bytes] = None,
    file_path: Optional[Path] = None
) -> bool:
    """
    ä¸Šä¼ æ¶ˆæ¯çš„ä¸»å…¥å£
    """
    client_name = self._get_client_name(client)
    
    # ç¡®ä¿å®¢æˆ·ç«¯çŠ¶æ€å­˜åœ¨
    if client_name not in self.client_upload_states:
        await self._initialize_client_state(client_name)
    
    # åˆ›å»ºä¸Šä¼ ä»»åŠ¡
    upload_task = {
        'type': 'media_group' if self._is_media_group_message(original_message) else 'single',
        'message': original_message,
        'media_data': media_data,
        'file_path': file_path,
        'client': client,
        'timestamp': time.time()
    }
    
    # æ·»åŠ åˆ°å®¢æˆ·ç«¯ä¸Šä¼ é˜Ÿåˆ—
    await self.client_upload_states[client_name].upload_queue.put(upload_task)
    
    return True
```

### 2. å®¢æˆ·ç«¯ä¸Šä¼ å¤„ç†å™¨

```python
async def _client_upload_processor(self, client_name: str):
    """
    å®¢æˆ·ç«¯ä¸Šä¼ å¤„ç†å™¨ - æ¯ä¸ªå®¢æˆ·ç«¯ä¸€ä¸ªç‹¬ç«‹çš„å¤„ç†åç¨‹
    """
    state = self.client_upload_states[client_name]
    
    while True:
        try:
            # ä»é˜Ÿåˆ—è·å–ä¸Šä¼ ä»»åŠ¡
            upload_task = await state.upload_queue.get()
            
            if upload_task is None:  # åœæ­¢ä¿¡å·
                break
            
            async with state.upload_lock:
                await self._process_upload_task(state, upload_task)
                
        except Exception as e:
            logger.error(f"å®¢æˆ·ç«¯ {client_name} ä¸Šä¼ å¤„ç†å¤±è´¥: {e}")
            
        finally:
            state.upload_queue.task_done()

async def _process_upload_task(self, state: ClientUploadState, task: Dict):
    """
    å¤„ç†å•ä¸ªä¸Šä¼ ä»»åŠ¡
    """
    if task['type'] == 'media_group':
        await self._handle_media_group_task(state, task)
    else:
        await self._handle_single_message_task(state, task)
```

### 3. åª’ä½“ç»„ä»»åŠ¡å¤„ç†

```python
async def _handle_media_group_task(self, state: ClientUploadState, task: Dict):
    """
    å¤„ç†åª’ä½“ç»„ä»»åŠ¡
    """
    message = task['message']
    media_group_id = message.media_group_id
    
    # æ£€æŸ¥åª’ä½“ç»„IDæ˜¯å¦å‘ç”Ÿå˜åŒ–
    if state.current_media_group_id != media_group_id:
        # åª’ä½“ç»„IDå˜åŒ–ï¼Œå…ˆä¸Šä¼ å½“å‰ç¼“å­˜çš„åª’ä½“ç»„
        if state.current_media_group_id and state.media_group_cache:
            logger.info(f"ğŸ“¤ åª’ä½“ç»„IDå˜åŒ–ï¼Œä¸Šä¼ ç¼“å­˜çš„åª’ä½“ç»„: {state.current_media_group_id}")
            await self._upload_cached_media_group(state)
        
        # å¼€å§‹æ–°çš„åª’ä½“ç»„
        state.current_media_group_id = media_group_id
        state.media_group_cache = []
        logger.info(f"ğŸ“¦ å¼€å§‹æ–°åª’ä½“ç»„: {media_group_id}")
    
    # æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰åª’ä½“ç»„ç¼“å­˜
    state.media_group_cache.append({
        'message': message,
        'media_data': task['media_data'],
        'file_path': task['file_path'],
        'client': task['client'],
        'timestamp': task['timestamp']
    })
    
    logger.info(f"åª’ä½“ç»„ {media_group_id} å½“å‰æœ‰ {len(state.media_group_cache)} ä¸ªæ–‡ä»¶")

async def _handle_single_message_task(self, state: ClientUploadState, task: Dict):
    """
    å¤„ç†å•æ¡æ¶ˆæ¯ä»»åŠ¡
    """
    # å•æ¡æ¶ˆæ¯å‡ºç°ï¼Œè¡¨ç¤ºå½“å‰åª’ä½“ç»„å·²å®Œæ•´ï¼Œå…ˆä¸Šä¼ ç¼“å­˜çš„åª’ä½“ç»„
    if state.current_media_group_id and state.media_group_cache:
        logger.info(f"ğŸ“¤ é‡åˆ°å•æ¡æ¶ˆæ¯ï¼Œä¸Šä¼ ç¼“å­˜çš„åª’ä½“ç»„: {state.current_media_group_id}")
        await self._upload_cached_media_group(state)
    
    # ç«‹å³ä¸Šä¼ å•æ¡æ¶ˆæ¯
    logger.info(f"ğŸ“„ ç«‹å³ä¸Šä¼ å•æ¡æ¶ˆæ¯: {task['message'].id}")
    await self._upload_single_message(
        task['client'],
        task['message'],
        task['media_data'],
        task['file_path']
    )
```

### 4. åª’ä½“ç»„ä¸Šä¼ å®ç°

```python
async def _upload_cached_media_group(self, state: ClientUploadState):
    """
    ä¸Šä¼ ç¼“å­˜çš„åª’ä½“ç»„
    """
    if not state.media_group_cache:
        return
    
    try:
        # å‡†å¤‡åª’ä½“åˆ—è¡¨
        input_media_list = []
        client = None
        
        for i, msg_data in enumerate(state.media_group_cache):
            client = msg_data['client']
            
            # åˆ›å»ºInputMediaå¯¹è±¡
            input_media = await self._create_input_media(
                msg_data['message'],
                msg_data['media_data'],
                msg_data['file_path'],
                caption=self._get_message_caption(msg_data['message']) if i == 0 else None
            )
            
            if input_media:
                input_media_list.append(input_media)
        
        if input_media_list and client:
            # å‘é€åª’ä½“ç»„
            await client.send_media_group(
                chat_id=self.upload_config.target_channel,
                media=input_media_list
            )
            
            self.upload_stats["media_groups_uploaded"] += 1
            self.upload_stats["total_uploaded"] += len(input_media_list)
            
            logger.info(f"âœ… åª’ä½“ç»„ {state.current_media_group_id} ä¸Šä¼ æˆåŠŸï¼ŒåŒ…å« {len(input_media_list)} ä¸ªæ–‡ä»¶")
        
    except Exception as e:
        logger.error(f"âŒ ä¸Šä¼ åª’ä½“ç»„å¤±è´¥: {e}")
        self.upload_stats["total_failed"] += len(state.media_group_cache)
    
    finally:
        # æ¸…ç†ç¼“å­˜
        state.current_media_group_id = None
        state.media_group_cache = []
```

## ğŸ¯ å…³é”®ä¼˜åŒ–ç‚¹

### 1. åŸºäºIDå˜åŒ–çš„å®Œæ•´æ€§æ£€æµ‹
- **å‡†ç¡®åˆ¤æ–­**: é€šè¿‡åª’ä½“ç»„IDå˜åŒ–è€Œéå›ºå®šæ•°é‡æ¥åˆ¤æ–­åª’ä½“ç»„å®Œæ•´æ€§
- **æ”¯æŒä»»æ„å¤§å°**: æ”¯æŒ2-10ä¸ªä»»æ„æ•°é‡çš„åª’ä½“ç»„
- **è¾¹ç•Œæ£€æµ‹**: å•æ¡æ¶ˆæ¯å‡ºç°æ—¶è‡ªåŠ¨å®Œæˆå½“å‰åª’ä½“ç»„

### 2. å®¢æˆ·ç«¯çº§åˆ«çš„ä¸Šä¼ é˜Ÿåˆ—
- **ç‹¬ç«‹é˜Ÿåˆ—**: æ¯ä¸ªå®¢æˆ·ç«¯ç»´æŠ¤ç‹¬ç«‹çš„ä¸Šä¼ é˜Ÿåˆ—
- **é¡ºåºä¿è¯**: ç¡®ä¿åŒä¸€å®¢æˆ·ç«¯çš„æ¶ˆæ¯æŒ‰é¡ºåºä¸Šä¼ 
- **å¹¶å‘å®‰å…¨**: ä½¿ç”¨å¼‚æ­¥é”é˜²æ­¢å¹¶å‘å†²çª

### 3. çŠ¶æ€ç®¡ç†ä¼˜åŒ–
- **å®¢æˆ·ç«¯éš”ç¦»**: ä¸åŒå®¢æˆ·ç«¯çš„çŠ¶æ€å®Œå…¨éš”ç¦»
- **å†…å­˜ç®¡ç†**: åŠæ—¶æ¸…ç†ç¼“å­˜ï¼Œé¿å…å†…å­˜æ³„æ¼
- **é”™è¯¯æ¢å¤**: å¼‚å¸¸æƒ…å†µä¸‹è‡ªåŠ¨é‡ç½®çŠ¶æ€

### 4. æ€§èƒ½æå‡
- **å¼‚æ­¥å¤„ç†**: æ¯ä¸ªå®¢æˆ·ç«¯ç‹¬ç«‹çš„å¼‚æ­¥å¤„ç†åç¨‹
- **æ‰¹é‡ä¸Šä¼ **: åª’ä½“ç»„ä»ç„¶æ‰¹é‡ä¸Šä¼ ï¼Œæé«˜æ•ˆç‡
- **èµ„æºä¼˜åŒ–**: åˆç†çš„é˜Ÿåˆ—å¤§å°å’Œç¼“å­˜ç®¡ç†

## ğŸ“Š å®ç°æ•ˆæœ

1. **å‡†ç¡®æ€§**: æ­£ç¡®å¤„ç†ä»»æ„å¤§å°çš„åª’ä½“ç»„ï¼ˆ2-10ä¸ªæ–‡ä»¶ï¼‰
2. **å®Œæ•´æ€§**: ç¡®ä¿åª’ä½“ç»„ä¸è¢«æ‹†åˆ†æˆ–é—æ¼
3. **é¡ºåºæ€§**: ä¿è¯ä¸Šä¼ é¡ºåºä¸ä¸‹è½½é¡ºåºä¸€è‡´
4. **å¹¶å‘æ€§**: æ”¯æŒå¤šå®¢æˆ·ç«¯å¹¶å‘ä¸Šä¼ è€Œä¸æ··ä¹±
5. **å¯é æ€§**: å®Œå–„çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ¢å¤æœºåˆ¶

è¿™ä¸ªä¼˜åŒ–çš„é€»è¾‘å®Œå…¨è§£å†³äº†åŸæœ‰çš„é—®é¢˜ï¼Œæä¾›äº†æ›´åŠ å¯é å’Œé«˜æ•ˆçš„åª’ä½“ç»„ä¸Šä¼ æœºåˆ¶ã€‚
