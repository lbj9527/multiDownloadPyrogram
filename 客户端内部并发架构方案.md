# å®¢æˆ·ç«¯å†…éƒ¨å¹¶å‘æ¶æ„æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

åœ¨æ¯ä¸ªå®¢æˆ·ç«¯å†…éƒ¨å®ç°ä¸‹è½½å’Œä¸Šä¼ åŒæ—¶è¿›è¡Œï¼Œä¿è¯åª’ä½“ç»„å®Œæ•´æ€§ã€‚

## ğŸ” å…³é”®å‘ç°

### åª’ä½“ç»„æ ¼å¼ä¿æŒçš„æ ¸å¿ƒå‡½æ•°

- **`_handle_media_group_task`** (services/upload_service.py:197)ï¼šåª’ä½“ç»„ç¼“å­˜å’Œè§¦å‘
- **`_upload_cached_media_group`** (services/upload_service.py:245)ï¼šæ‰¹é‡ä¸Šä¼ ä¿æŒæ ¼å¼
- **æ ¸å¿ƒ API**ï¼š`client.send_media_group()` ä¿æŒåª’ä½“ç»„æ ¼å¼

## ğŸ”„ ç®€åŒ–å¹¶å‘æ¶æ„

### å®¢æˆ·ç«¯å†…éƒ¨å¹¶å‘æµç¨‹

```
æ¯ä¸ªå®¢æˆ·ç«¯å†…éƒ¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯å¤„ç†æ¶ˆæ¯åˆ—è¡¨                        â”‚
â”‚                                         â”‚
â”‚ æ¶ˆæ¯1 â†’ ä¸‹è½½ â†’ ç«‹å³æ”¾å…¥é˜Ÿåˆ—               â”‚
â”‚ æ¶ˆæ¯2 â†’ ä¸‹è½½ â†’ ç«‹å³æ”¾å…¥é˜Ÿåˆ—               â”‚
â”‚ æ¶ˆæ¯3 â†’ ä¸‹è½½ â†’ ç«‹å³æ”¾å…¥é˜Ÿåˆ—               â”‚
â”‚   â†“                    â†“                â”‚
â”‚ ç»§ç»­ä¸‹è½½ä¸‹ä¸€æ¡      ä¸Šä¼ æ¶ˆè´¹è€…             â”‚
â”‚                   (åª’ä½“ç»„ç¼“å­˜+æ‰¹é‡ä¸Šä¼ )    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ï¼šä¸‹è½½å®Œæˆç«‹å³å…¥é˜Ÿï¼Œä¸ç­‰å¾…ä¸Šä¼ 
```

## ğŸ”§ æœ€å°ä¿®æ”¹å®ç°

### åœ¨å­˜å‚¨ç­–ç•¥ä¸­æ·»åŠ ç®€å•é˜Ÿåˆ—

```python
class UploadStorageStrategy:
    def __init__(self, upload_handler):
        self.upload_handler = upload_handler
        # æ·»åŠ ç®€å•çš„å¼‚æ­¥é˜Ÿåˆ—
        self.upload_queue = asyncio.Queue(maxsize=100)
        self.upload_task = None

        # å¤ç”¨ç°æœ‰åª’ä½“ç»„å¤„ç†çŠ¶æ€
        self.current_media_group_id = None
        self.media_group_cache = []

    async def process_message(self, client, message, channel, message_handler):
        """ä¸‹è½½å®Œæˆåç«‹å³å…¥é˜Ÿï¼Œä¸ç­‰å¾…ä¸Šä¼ """
        # ä¸‹è½½æ¶ˆæ¯ï¼ˆå¤ç”¨ç°æœ‰é€»è¾‘ï¼‰
        if message_handler.has_media(message):
            media_data = await message_handler._download_media_to_memory(client, message)
            if not media_data:
                return False
        else:
            media_data = None

        # åˆ›å»ºä¸Šä¼ ä»»åŠ¡
        upload_task = {
            'message': message,
            'media_data': media_data,
            'client': client
        }

        # ç«‹å³å…¥é˜Ÿï¼Œä¸ç­‰å¾…ä¸Šä¼ 
        await self.upload_queue.put(upload_task)

        # å¯åŠ¨ä¸Šä¼ æ¶ˆè´¹è€…ï¼ˆå¦‚æœè¿˜æ²¡å¯åŠ¨ï¼‰
        if not self.upload_task:
            self.upload_task = asyncio.create_task(self._upload_consumer())

        return True  # ç«‹å³è¿”å›ï¼Œä¸Šä¼ åœ¨åå°è¿›è¡Œ

    async def _upload_consumer(self):
        """ä¸Šä¼ æ¶ˆè´¹è€… - å¤ç”¨ç°æœ‰åª’ä½“ç»„å¤„ç†é€»è¾‘"""
        while True:
            try:
                task = await self.upload_queue.get()

                # ç›´æ¥è°ƒç”¨ç°æœ‰çš„åª’ä½“ç»„å¤„ç†é€»è¾‘
                await self._handle_media_group_upload(task)

            except Exception as e:
                logger.error(f"ä¸Šä¼ æ¶ˆè´¹è€…å¼‚å¸¸: {e}")

    async def _handle_media_group_upload(self, task):
        """å¤ç”¨ç°æœ‰çš„åª’ä½“ç»„å¤„ç†é€»è¾‘"""
        message = task['message']
        media_group_id = getattr(message, 'media_group_id', None)

        # å®Œå…¨å¤ç”¨ç°æœ‰é€»è¾‘
        if media_group_id:
            # æ£€æŸ¥åª’ä½“ç»„IDå˜åŒ–
            if self.current_media_group_id != media_group_id:
                # ä¸Šä¼ å½“å‰ç¼“å­˜çš„åª’ä½“ç»„
                if self.current_media_group_id and self.media_group_cache:
                    await self._upload_current_media_group()

                # å¼€å§‹æ–°åª’ä½“ç»„
                self.current_media_group_id = media_group_id
                self.media_group_cache = []

            # ç¼“å­˜å½“å‰æ¶ˆæ¯
            self.media_group_cache.append(task)
        else:
            # å•æ¡æ¶ˆæ¯ï¼Œå…ˆä¸Šä¼ ç¼“å­˜çš„åª’ä½“ç»„
            if self.media_group_cache:
                await self._upload_current_media_group()

            # ç›´æ¥ä¸Šä¼ å•æ¡æ¶ˆæ¯
            await self.upload_handler.handle_upload(
                task['client'], message, media_data=task['media_data']
            )

    async def _upload_current_media_group(self):
        """ä¸Šä¼ å½“å‰ç¼“å­˜çš„åª’ä½“ç»„ - è°ƒç”¨ç°æœ‰å‡½æ•°"""
        if not self.media_group_cache:
            return

        # ç›´æ¥è°ƒç”¨ç°æœ‰çš„ä¸Šä¼ æœåŠ¡é€»è¾‘
        # è¿™é‡Œå¤ç”¨ upload_service çš„ send_media_group åŠŸèƒ½
        await self.upload_handler.upload_media_group(self.media_group_cache)

        # æ¸…ç†ç¼“å­˜
        self.current_media_group_id = None
        self.media_group_cache = []
```

### ç¨‹åºç»“æŸæ—¶æ¸…ç†

```python
async def cleanup(self):
    """ç¨‹åºç»“æŸæ—¶æ¸…ç†å‰©ä½™ç¼“å­˜"""
    # åœæ­¢æ¥æ”¶æ–°ä»»åŠ¡
    if self.upload_task:
        self.upload_task.cancel()

    # ä¸Šä¼ å‰©ä½™çš„åª’ä½“ç»„
    if self.media_group_cache:
        await self._upload_current_media_group()
```

## ğŸ¯ å…³é”®ä¼˜åŠ¿

### 1. æœ€å°ä¿®æ”¹

- **åªä¿®æ”¹å­˜å‚¨ç­–ç•¥**ï¼šåœ¨ç°æœ‰ `UploadStorageStrategy` ä¸­æ·»åŠ é˜Ÿåˆ—
- **å¤ç”¨ç°æœ‰é€»è¾‘**ï¼šç›´æ¥ä½¿ç”¨ç°æœ‰çš„åª’ä½“ç»„å¤„ç†æœºåˆ¶
- **ä¿æŒæ¶æ„ä¸å˜**ï¼šä¸ä¿®æ”¹æ¶ˆæ¯åˆ†ç»„å’Œä»»åŠ¡åˆ†é…

### 2. çœŸæ­£å¹¶å‘

- **ä¸‹è½½ä¸ç­‰å¾…ä¸Šä¼ **ï¼šä¸‹è½½å®Œæˆç«‹å³å…¥é˜Ÿï¼Œç»§ç»­ä¸‹è½½ä¸‹ä¸€æ¡
- **å®¢æˆ·ç«¯å†…éƒ¨å¹¶å‘**ï¼šæ¯ä¸ªå®¢æˆ·ç«¯å†…éƒ¨ä¸‹è½½å’Œä¸Šä¼ åŒæ—¶è¿›è¡Œ
- **ä¿æŒåª’ä½“ç»„å®Œæ•´æ€§**ï¼šå¤ç”¨ç°æœ‰çš„ç¼“å­˜å’Œè§¦å‘é€»è¾‘

## ğŸ“Š é¢„æœŸæ•ˆæœ

- **æ€§èƒ½æå‡**ï¼šç†è®ºæå‡ 2-3 å€å¤„ç†é€Ÿåº¦
- **åª’ä½“ç»„ä¿è¯**ï¼šä½¿ç”¨ç°æœ‰çš„ `send_media_group` æœºåˆ¶ä¿æŒæ ¼å¼
- **å‘åå…¼å®¹**ï¼šraw æ¨¡å¼å®Œå…¨ä¸å—å½±å“

## ğŸš€ å®æ–½æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶

åªéœ€ä¿®æ”¹ `core/storage_strategies.py` ä¸­çš„ `UploadStorageStrategy` ç±»ï¼š

1. æ·»åŠ  `asyncio.Queue` é˜Ÿåˆ—
2. æ·»åŠ ä¸Šä¼ æ¶ˆè´¹è€…ä»»åŠ¡
3. å¤ç”¨ç°æœ‰åª’ä½“ç»„å¤„ç†é€»è¾‘
4. æ·»åŠ ç¨‹åºç»“æŸæ—¶çš„æ¸…ç†æœºåˆ¶

### ä½¿ç”¨æ–¹å¼

ç¨‹åºä½¿ç”¨æ–¹å¼å®Œå…¨ä¸å˜ï¼Œä¼šè‡ªåŠ¨åœ¨å®¢æˆ·ç«¯å†…éƒ¨å®ç°å¹¶å‘å¤„ç†ã€‚
